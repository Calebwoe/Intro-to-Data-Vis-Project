<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NORS Faceted Scatterplots</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body { 
      font-family: Arial; 
      margin: 20px;
    }

    .facet-title {
      font-size: 12px;
      font-weight: bold;
      text-anchor: middle;
    }

    .dot {
      opacity: 0.75;
    }

    .button-row {
      margin-bottom: 20px;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 25px;
    }

    button {
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>NORS Outbreaks by Etiology</h2>

<div class="button-row">
  <button id="btnDeaths">Deaths</button>
  <button id="btnHosp">Hospitalizations</button>
  <button id="btnIll">Illnesses</button>
</div>

<div id="chart" class="chart-grid"></div>

<script>

// Scatterplot dimensions
const facetWidth = 250;
const facetHeight = 200;
const margin = { top: 30, right: 20, bottom: 30, left: 40 };

// Load the CSV file
d3.csv("nors_cleaned.csv").then(data => {

  // Convert numerics
  data.forEach(d => {
    d.Year = +d.Year;
    d.Illnesses = +d.Illnesses;
    d.Hospitalizations = +d.Hospitalizations;
    d.Deaths = +d.Deaths;
  });

  // Extract unique etiologies
  const etiologies = Array.from(new Set(data.map(d => d.Etiology)));

  const container = d3.select("#chart");

  // -------- DRAW FACETS FUNCTION ----------
  function drawFacets(metric) {
    container.selectAll("*").remove(); // Clear old plots

    etiologies.forEach(et => {
      const subset = data.filter(d => d.Etiology === et);

      const svg = container.append("svg")
        .attr("width", facetWidth)
        .attr("height", facetHeight);

      // X scale (years)
      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.Year))
        .range([margin.left, facetWidth - margin.right]);

      // Y scale (selected metric)
      const y = d3.scaleLinear()
        .domain([0, d3.max(subset, d => d[metric]) || 0])
        .nice()
        .range([facetHeight - margin.bottom, margin.top]);

      // X axis
      svg.append("g")
        .attr("transform", `translate(0, ${facetHeight - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("d")));

      // Y axis
      svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(y).ticks(4));

      // Scatter points
      svg.append("g")
        .selectAll("circle")
        .data(subset)
        .enter()
        .append("circle")
          .attr("class", "dot")
          .attr("cx", d => x(d.Year))
          .attr("cy", d => y(d[metric]))
          .attr("r", 4)
          .attr("fill", "steelblue");

      // Title
      svg.append("text")
        .attr("class", "facet-title")
        .attr("x", facetWidth / 2)
        .attr("y", margin.top - 10)
        .text(et);
    });
  }

  // ------- Initialize with Deaths -------
  drawFacets("Deaths");

  // ------- Button event listeners -------
  d3.select("#btnDeaths").on("click", () => drawFacets("Deaths"));
  d3.select("#btnHosp").on("click", () => drawFacets("Hospitalizations"));
  d3.select("#btnIll").on("click", () => drawFacets("Illnesses"));

});

</script>

</body>
</html>
