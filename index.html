<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NORS Faceted Scatterplots</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body { font-family: Arial; }
    .facet-title {
      font-size: 12px;
      font-weight: bold;
      text-anchor: middle;
    }
    .dot {
      opacity: 0.7;
    }
  </style>
</head>

<body>

<h2>NORS Outbreaks by Etiology</h2>

<label for="metric">Select Metric:</label>
<select id="metric">
  <option value="Deaths" selected>Deaths</option>
  <option value="Hospitalizations">Hospitalizations</option>
  <option value="Illnesses">Illnesses</option>
</select>

<div id="chart"></div>

<script>

// Chart dimensions
const facetWidth = 250;
const facetHeight = 200;
const margin = { top: 30, right: 20, bottom: 30, left: 40 };

// Load data
d3.csv("nors_cleaned.csv").then(data => {

  // Convert numeric values
  data.forEach(d => {
    d.Year = +d.Year;
    d.Illnesses = +d.Illnesses;
    d.Hospitalizations = +d.Hospitalizations;
    d.Deaths = +d.Deaths;
  });

  // Unique etiologies
  const etiologies = Array.from(new Set(data.map(d => d.Etiology)));

  // Create container
  const container = d3.select("#chart")
    .append("div")
    .style("display", "grid")
    .style("grid-template-columns", "repeat(auto-fill, 260px)")
    .style("gap", "20px");

  function updateChart(metric) {
    container.selectAll("*").remove(); // clear previous facets

    etiologies.forEach(et => {
      const subset = data.filter(d => d.Etiology === et);

      const svg = container
        .append("svg")
        .attr("width", facetWidth)
        .attr("height", facetHeight);

      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.Year))
        .range([margin.left, facetWidth - margin.right]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(subset, d => d[metric]) || 1])
        .nice()
        .range([facetHeight - margin.bottom, margin.top]);

      // Axes
      svg.append("g")
        .attr("transform", `translate(0,${facetHeight - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("d")));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(4));

      // Points
      svg.append("g")
        .selectAll("circle")
        .data(subset)
        .enter()
        .append("circle")
          .attr("class", "dot")
          .attr("cx", d => x(d.Year))
          .attr("cy", d => y(d[metric]))
          .attr("r", 4)
          .attr("fill", "steelblue");

      // Title
      svg.append("text")
        .attr("class", "facet-title")
        .attr("x", facetWidth / 2)
        .attr("y", margin.top - 10)
        .text(et);
    });
  }

  // Initialize with Deaths
  updateChart("Deaths");

  // Dropdown handler
  d3.select("#metric").on("change", event => {
    updateChart(event.target.value);
  });

});

</script>

</body>
</html>
