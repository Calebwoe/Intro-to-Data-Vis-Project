<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NORS Faceted Scatterplots (Top 8 Etiologies)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body { 
      font-family: Arial; 
      margin: 20px;
    }

    .facet-title {
      font-size: 12px;
      font-weight: bold;
      text-anchor: middle;
    }

    .dot {
      opacity: 0.75;
    }

    .button-row {
      margin-bottom: 20px;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 25px;
    }

    button {
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>NORS Outbreaks â€” Top 8 Etiologies</h2>

<div class="button-row">
  <button id="btnDeaths">Deaths</button>
  <button id="btnHosp">Hospitalizations</button>
  <button id="btnIll">Illnesses</button>
</div>

<div id="chart" class="chart-grid"></div>

<script>

// *** Top 8 etiologies you selected ***
const topEtiologies = new Set([
  "Norovirus",
  "Salmonella",
  "escherichia coli, shiga toxin-producing",
  "Campylobacter",
  "Shigella",
  "Cryptosporidium",
  "legionella pneumophila",
  "clostridium perfringens"
]);

// Scatterplot dimensions
const facetWidth = 250;
const facetHeight = 200;
const margin = { top: 30, right: 20, bottom: 30, left: 40 };

// Load CSV
d3.csv("nors_cleaned.csv").then(data => {

  // Convert numeric fields
  data.forEach(d => {
    d.Year = +d.Year;
    d.Illnesses = +d.Illnesses;
    d.Hospitalizations = +d.Hospitalizations;
    d.Deaths = +d.Deaths;
  });

  // Filter to only top 8
  const filteredData = data.filter(d => topEtiologies.has(d.Etiology));

  const etiologies = Array.from(topEtiologies);

  const container = d3.select("#chart");

  // DRAW ALL FACETS
  function drawFacets(metric) {
    container.selectAll("*").remove();

    etiologies.forEach(et => {
      const subset = filteredData.filter(d => d.Etiology === et);

      const svg = container.append("svg")
        .attr("width", facetWidth)
        .attr("height", facetHeight);

      const x = d3.scaleLinear()
        .domain(d3.extent(filteredData, d => d.Year))
        .range([margin.left, facetWidth - margin.right]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(subset, d => d[metric]) || 0])
        .nice()
        .range([facetHeight - margin.bottom, margin.top]);

      svg.append("g")
        .attr("transform", `translate(0, ${facetHeight - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("d")));

      svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(y).ticks(4));

      svg.append("g")
        .selectAll("circle")
        .data(subset)
        .enter()
        .append("circle")
          .attr("class", "dot")
          .attr("cx", d => x(d.Year))
          .attr("cy", d => y(d[metric]))
          .attr("r", 4)
          .attr("fill", "steelblue");

      svg.append("text")
        .attr("class", "facet-title")
        .attr("x", facetWidth / 2)
        .attr("y", margin.top - 10)
        .text(et);
    });
  }

  drawFacets("Deaths");

  d3.select("#btnDeaths").on("click", () => drawFacets("Deaths"));
  d3.select("#btnHosp").on("click", () => drawFacets("Hospitalizations"));
  d3.select("#btnIll").on("click", () => drawFacets("Illnesses"));

});

</script>

</body>
</html>
